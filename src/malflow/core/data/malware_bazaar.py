import os.path

from malflow.core.api.malware_bazaar import MalwareBazaarAPI
from malflow.core.data import DatasetProvider
from malflow.core.model.sample import Sample


class MalwareBazaar(DatasetProvider):

    @staticmethod
    def get_sample(md5: str = None, sha256: str = None) -> Sample:
        expected_path = os.path.join(MalwareBazaar.get_dir_samples(), f"{sha256}.mbazaar")
        if os.path.isfile(expected_path):
            return Sample(filepath=expected_path, sha256=sha256)

        code, data, msg = MalwareBazaarAPI.download_sample(sha256=sha256, download_dir=MalwareBazaar.get_dir_samples())
        if code != 200:
            raise Exception(f"Cannot find MalwareBazaar file: {sha256}")
        return Sample(filepath=data["path"], sha256=sha256)

    @staticmethod
    def get_dir_samples():
        return os.environ["MBAZAAR_DIR_SAMPLES"]

    @staticmethod
    def get_dir_r2_scans():
        return os.environ["MBAZAAR_DIR_R2_SCANS"]
